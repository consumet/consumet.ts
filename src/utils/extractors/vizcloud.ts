import axios from 'axios';

import { VideoExtractor, IVideo, ISubtitle, Intro } from '../../models';
import { USER_AGENT } from '..';

class VizCloud extends VideoExtractor {
  protected override serverName = 'VizCloud';
  protected override sources: IVideo[] = [];

  private readonly host = 'https://vizcloud.site';
  // lagrad :)
  private readonly keys = {
    cipher: 'W0XfiVV10gfl5z34',
    encrypt: 'fIloqyPzN2hkCY6EW34ASDMgrRHXvw/O5c7T8BnFt1+GmLUjiJuQpe0Vsb9dZaKx',
    main: 'W0XfiVV10gfl5z34',
    dashTable:
      '69 390 62 130 70 520 69 390 62 130 70 520 69 390 62 130 70 396 63 132 71 528 70 396 63 132 71 528 70 396 63 132 71 402 64 134 72 536 71 402 64 134 72 536 71 402 64 134 72 408 65 136 73 544 72 408 65 136 73 544 72 408 65 136 73 414 66 138 74 552 73 414 66 138 74 552 73 414 66 138 74 420 67 140 75 560 74 420 67 140 75 560 74 420 67 140 75 426 68 142 76 568 75 426 68 142 76 568 75 426 68 142 76 432 69 144 77 576 76 432 69 144 77 576 76 432 69 144 77 438 70 146 78 584 77 438 70 146 78 584 77 438 70 146 78 444 71 148 79 592 78 444 71 148 79 592 78 444 71 148 79 450 72 150 80 600 79 450 72 150 80 600 79 450 72 150 80 456 73 152 81 608 80 456 73 152 81 608 80 456 73 152 81 462 74 154 82 616 81 462 74 154 82 616 81 462 74 154 82 468 75 156 83 624 82 468 75 156 83 624 82 468 75 156 83 474 76 158 84 632 83 474 76 158 84 632 83 474 76 158 84 480 77 160 85 640 84 480 77 160 85 640 84 480 77 160 85 486 78 162 86 648 85 486 78 162 86 648 85 486 78 162 86 492 79 164 87 656 86 492 79 164 87 656 86 492 79 164 87 498 80 166 88 664 87 498 80 166 88 664 87 498 80 166 88 504 81 168 89 672 88 504 81 168 89 672 88 504 81 168 89 510 82 170 90 680 89 510 82 170 90 680 89 510 82 170 90 516 83 172 91 688 90 516 83 172 91 688 90 516 83 172 91 522 84 174 92 696 91 522 84 174 92 696 91 522 84 174 92 528 85 176 93 704 92 528 85 176 93 704 92 528 85 176 93 534 86 178 94 712 93 534 86 178 94 712 93 534 86 178 94 540 87 180 95 720 94 540 87 180 95 720 94 540 87 180 101 582 94 194 102 776 101 582 94 194 102 776 101 582 94 194 102 588 95 196 103 784 102 588 95 196 103 784 102 588 95 196 103 594 96 198 104 792 103 594 96 198 104 792 103 594 96 198 104 600 97 200 105 800 104 600 97 200 105 800 104 600 97 200 105 606 98 202 106 808 105 606 98 202 106 808 105 606 98 202 106 612 99 204 107 816 106 612 99 204 107 816 106 612 99 204 107 618 100 206 108 824 107 618 100 206 108 824 107 618 100 206 108 624 101 208 109 832 108 624 101 208 109 832 108 624 101 208 109 630 102 210 110 840 109 630 102 210 110 840 109 630 102 210 110 636 103 212 111 848 110 636 103 212 111 848 110 636 103 212 111 642 104 214 112 856 111 642 104 214 112 856 111 642 104 214 112 648 105 216 113 864 112 648 105 216 113 864 112 648 105 216 113 654 106 218 114 872 113 654 106 218 114 872 113 654 106 218 114 660 107 220 115 880 114 660 107 220 115 880 114 660 107 220 115 666 108 222 116 888 115 666 108 222 116 888 115 666 108 222 116 672 109 224 117 896 116 672 109 224 117 896 116 672 109 224 117 678 110 226 118 904 117 678 110 226 118 904 117 678 110 226 118 684 111 228 119 912 118 684 111 228 119 912 118 684 111 228 119 690 112 230 120 920 119 690 112 230 120 920 119 690 112 230 120 696 113 232 121 928 120 696 113 232 121 928 120 696 113 232 121 702 114 234 122 936 121 702 114 234 122 936 121 702 114 234 122 708 115 236 123 944 122 708 115 236 123 944 122 708 115 236 123 714 116 238 124 952 123 714 116 238 124 952 123 714 116 238 124 720 117 240 125 960 124 720 117 240 125 960 124 720 117 240 125 726 118 242 126 968 125 726 118 242 126 968 125 726 118 242 126 732 119 244 127 976 126 732 119 244 127 976 126 732 119 244 52 288 45 96 53 384 52 288 45 96 53 384 52 288 45 96 53 294 46 98 54 392 53 294 46 98 54 392 53 294 46 98 54 300 47 100 55 400 54 300 47 100 55 400 54 300 47 100 55 306 48 102 56 408 55 306 48 102 56 408 55 306 48 102 56 312 49 104 57 416 56 312 49 104 57 416 56 312 49 104 57 318 50 106 58 424 57 318 50 106 58 424 57 318 50 106 58 324 51 108 59 432 58 324 51 108 59 432 58 324 51 108 59 330 52 110 60 440 59 330 52 110 60 440 59 330 52 110 60 336 53 112 61 448 60 336 53 112 61 448 60 336 53 112 61 342 54 114 62 456 61 342 54 114 62 456 61 342 54 114 47 258 40 86 48 344 47 258 40 86 48 344 47 258 40 86 65 366 58 122 66 488 65 366 58 122 66 488 65 366 58 122 51 282 44 94 52 376 51 282 44 94 52 376 51 282 44 94 99 570 92 190 100 760 99 570 92 190 100 760 99 570 92 190',
  };
  private readonly base64Table = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+=/_';

  override extract = async (
    videoUrl: URL,
    cipher: (query: string, key: string) => string,
    encrypt: (query: string, key: string) => string
  ): Promise<IVideo[]> => {
    const groups = videoUrl.href.split('/');

    const id = encrypt(cipher(encrypt(groups[4], this.keys.encrypt), this.keys.cipher), this.keys.encrypt);

    const url = `${this.host}/mediainfo/${this.dashify(id)}?key=${this.keys.main}`;
    const { data } = await axios.get(url, {
      headers: {
        Referer: videoUrl.href,
      },
    });
    console.log(url);
    console.log(data);
    return this.sources;
  };

  private dashify = (id: string): string => {
    const table = this.keys.dashTable.split(' ');
    const dashedId = id
      .split('')
      .map((char, i) => table[this.base64Table.indexOf(char) * 16 + (i % 16)])
      .join('-');

    return dashedId;
  };
}

export default VizCloud;
